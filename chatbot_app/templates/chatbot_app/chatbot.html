<!DOCTYPE html>
<html>
<head>
    <title>Gemini Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-md w-96">
        <h1 class="text-2xl font-bold mb-4">Gemini Chatbot</h1>
        <div id="chat-area" class="mb-4 h-64 overflow-y-auto"></div>
        <div class="flex">
            <input type="text" id="user-input" class="shadow appearance-none border rounded w-full py-2 px-3 mr-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Type your message...">
            <button id="send-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Send</button>
        </div>
        {% csrf_token %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatArea = document.getElementById('chat-area');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');

            sendButton.addEventListener('click', function() {
                const message = userInput.value;
                if (message) {
                    // Display user message
                    displayMessage('You: ' + message, 'user');

                    // Send message to Django backend
                    fetch('/chatbot/get_response/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': getCookie('csrftoken')  // Important for Django CSRF protection
                        },
                        body: 'user_input=' + message
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.response) {
                            // Display Gemini response
                            displayMessage('Gemini: ' + data.response, 'gemini');
                        } else {
                            displayMessage('Error: ' + data.error, 'error');
                        }
                    })
                    .catch(error => {
                        displayMessage('Error: ' + error, 'error');
                    });

                    userInput.value = ''; // Clear input
                }
            });

            function displayMessage(message, sender) {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${sender}`;
                messageElement.textContent = message;
                chatArea.appendChild(messageElement);
                chatArea.scrollTop = chatArea.scrollHeight; // Scroll to bottom
            }

            // Function to get CSRF token from cookies (Django requirement)
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>
</body>
</html>